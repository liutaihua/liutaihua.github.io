<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="liutaihua" />
    
    <title>nodejs的机器人hubot集成到gtalk</title>
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/atom.xml" rel="alternate" title="yeah, the stuff" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/css/style.css">
    <link rel="stylesheet" href="/media/css/github.css">
    <link rel="stylesheet" href="/media/css/fontawesome.css">
    <script src="/media/js/jquery-1.7.1.min.js" type="text/javascript" charset="utf-8"></script> 
    <script type="text/javascript" src="/media/js/highlight.pack.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
  </head>
  <body>
      <div id="main" role="main">
        <header>
          <div id="header">
            <h1><a title="yeah, the stuff" class="" href="/">yeah, the stuff</a></h1>
          </div>
          <nav>
            
            <span><a title="Archive" href="/archive.html"><i class="fa fa-list-ul"></i></a></span>
            
            <span><a title="Tags" href="/tags.html"><i class="fa fa-tags"></i></a></span>
            
            <span><a title="About" href="/about.html"><i class="fa fa-user"></i></a></span>
            
            <span><a title="Gallery" href="http://www.flickr.com/photos/liutaihua/"><i class="fa fa-film"></i></a></span>
            
            <span><a title="Blogroll" href="/links.html"><i class="fa fa-link"></i></a></span>
            
            <span><a title="Subscribe" href="/atom.xml"><i class="fa fa-rss"></i></a></span>
            
          </nav>
        </header>
        <div id="content">
        <article>
  <section class="title">
    <h2>nodejs的机器人hubot集成到gtalk </h2>
  </section>
  <section class="meta">
  <span class="time">
    <time datetime="2013-04-26">2013-04-26</time>
  </span>
  
  <span class="tags">
    
    <a href="/tags.html#move from old blog" title="move from old blog">#move from old blog</a>
    
    <a href='https://github.com/liutaihua/liutaihua.github.io/blob/master/_posts/2013-04-26-nodejs的机器人hubot集成到gtalk.markdown'>编辑</a>
  </span>
  <!-- BEGIN this would not work on any other domain -->
  <span id="like-wrapper"></span>
  <script type="text/javascript">
    var like_shortname      = 'gopherwood';
    var like_identifier     = 'urn:uuid:4b740694-ab1f-11e3-baaa-040ccecf359c';
    var like_like_btn       = '&#xf087;';
    var like_unlike_btn     = '&#xf087;';
    var like_disable_unlike = true;

    var l = document.createElement('script'); l.type = 'text/javascript'; l.async = true;
    l.src = 'https://like-waynezhang.rhcloud.com/javascript/widget.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(l);
  </script>
  <!-- END this would not work on any other domain -->
  
  </section>
  <section class="post">
  <p>hubot 机器人, 居然今天才去了解了下它, 用nodejs运行, coffee javascrpit写的.</p>

<p>记录下安装方式<br/>
如果是redhat系列的linux, 使用yum 安装即可, centos6后的nodejs版本已经很新了.
实在不行就搞源码安装.</p>

<p>1, clone代码<br/>
    git clone https://github.com/github/hubot</p>

<p>2, 安装依赖
    cd hubot &amp;&amp; npm install</p>

<p>3, 尝试运行<br/>
    ./bin/hubot
在出现的hubot的console 输入hubot help看看帮助命令吧, 输入pug me命令, 如果正常会返回一个http链接, 打开页面是个可爱的狗狗.</p>

<p>4,  将hubot和gtalk连接<br/>
用./bin/hubot -h可以看到帮助, 其中-a参数表示指定adapter<br/>
git clone git://github.com/atmos/hubot-gtalk.git 获取gtalk的adapter代码, 直接将hubot-gtalk放在hubot的node_modules下, 方便hubot查找库.</p>

<p>关于连接gtalk的文档, 可以查看  https://github.com/github/hubot/wiki/Adapter:-Gtalk<br/>
其实很简单, 设定2个系统环境变量: HUBOT_GTALK_USERNAME, HUBOT_GTALK_PASSWORD
我的做法非常暴力, 我直接编辑 node_modules/hubot-gtalk/src/gtalk.coffee  修改<br/>
    # Client Options
    @options =
      username: 'xxxxx@gmail.com'
      password: 'xxxxxxxxx'</p>

<p>还有一个系统变量需要注意, hubot运行时,比如直接./bin/hubot -a shell默认会监听端口, 而端口值使用的是环境变量PORT, 默认是8080 ,如果被占用, hubot程序启动不了. 所以设定下 export PORT=8989之类的端口.</p>

<p>前面说道的gtalk这个adapter, 源文件其实就是  node_modules/hubot-gtalk/src/gtalk.coffee, 我在使用过程中发现, 里面有个TextMessage函数在用前没有导入, 会导致运行后, 虽然hubot能连接gtalk, 但是无法响应你的消息,  稍作修改(node_modules/hubot-gtalk/src/gtalk.coffee):</p>

<p>Adapter       = require '/root/app/hubot/src/adapter'
{TextMessage} = require '/root/app/hubot/src/message'</p>

<p>同时依葫画瓢, 写了一个isAllowUser方法, 用于验证用户, 不能谁都邀请你这个hubot聊天, 然后就向hubot发命令吧, 因为我的hubot里写了一些系统相关的, 怕不安全.
user_list =
  'defage': 'admin'
  'liutaihua2008': 'user'</p>

<p>  isAllowUser: (jid) ->
    name = jid.user
    if user_list[name] == undefined
      return false
    return true</p>

<p>在handlePresence 函数里调用一下, 验证不通过就不进行后面的动作了<br/>
    if not @isAllowUser(jid)
      return</p>

<p>5, 成功连上gtalk之后, 能用了, happy了一会, 可是机器人比较傻, 才懂简单的那么几个示例命令, 下面是自己扩展它的方法:<br/>
在src/scripts/路径下, 是命令脚本, 随便捡一个看一眼, 会发现挺简单, 脚本里有一条注释, 会被用作help命令的输出</p>

<p><code># Commands:</code><br/>
<code>#   hubot email &lt;user@email.com&gt; -s &lt;subject&gt; -m &lt;message&gt; - Sends email with the &lt;subject&gt; &lt;message&gt; to address &lt;user@email.com&gt;</code>
就是这行了, 虽然是注释, 不过会被当作hubot help的输出.</p>

<p>暂时我修改了自带的math.coffee,  计算器么, 原来的居然还跑到google上去来一轮, 然后计算好了返回, 放着现成的eval干吗不用, 危险就危险. 反正我是自己用.</p>

<p>增加了一个cmd.coffee 接收消息里的参数, js我太菜了, 于是就用exec方法, 把命令全部丢给一个写好的process.py, 然后在py里就可以想干吗就干吗了,  需要注意的是, js里读输出读的是stdout, 如果stdout没东西, 使用msg.send sdtout返回消息时, 可能会是空的, 只需要在process.py里稍做注意即可.
下面是这个cmd.coffee脚本内容:</p>

<pre>
</code>
 # Description:
 #   Email from hubot to any address
 #
 # Dependencies:
 #   None
 #
 # Configuration:
 #   None
 #
 # Commands:
 #   hubot email <user@email.com> -s <subject> -m <message> - Sends email with the <subject> <message> to address <user@email.com>
 #
 # Author:
 #   earlonrails
 #
 # Additional Requirements
 #   unix mail client installed on the system

util = require 'util'
child_process = require 'child_process'
exec = child_process.exec

module.exports = (robot) ->
  # email by pmail scripts
  robot.respond /email (.*) -s (.*) -m (.*)/i, (msg) ->
    mailCommand = """python /root/app/hubot/src/scripts/pmail.py -t '#{msg.match[1]}' -s '#{msg.match[2]}' -c '#{msg.match[3]}'"""
    exec mailCommand, (error, stdout, stderr) ->
      msg.send stdout

  # 执行系统命令
  robot.hear /cmd (.*)/i, (msg) ->
    if msg.match[1] == 'top'
      exec 'top -bn 1', (error, stdout, stderr) ->
        msg.send stdout
    exec msg.match[1], (error, stdout, stderr) ->
      msg.send stdout

  robot.hear /defage (.*)/i, (msg) ->
    #term   = "\"#{msg.match[1]}\""
    term = msg.match[1]
    cmd = """python /root/app/hubot/process.py --action '#{term}'"""
    exec cmd, (error, stdout, stderr) ->
      msg.send stdout

</code>
</pre>


<p>robot.hear和robot.respond似乎是一样的, 不过robot.hear看起来更符合机器人聊天.
接下来怎么调教它, 就看你想这么搞了,  以后想到点好玩的, 再给它加上吧. 我的机器人是 robotblabla@gmail.com</p>

  </section>
  
  <div class="divider">
    <span>
    
    <a href="/2013/04/25/process-smaps-analysis.html"><i class="fa fa-chevron-left"></i></a>
    
    </span>
    <!-- BEGIN comment icon
    <span><a href="javascript:leave_comment();" id="leave_comment_link"><i class="fa fa-comment-o"></i></a></span>
    <span><a href="javascript:collapse_comment();" id="collapse_comment_link" style="display:none;"><i class="fa fa-chevron-up"></i></a></span>
      END comment icon -->

    <span>
    
    <a href="/2013/04/27/hubot-nodejs-to-python-script.html"><i class="fa fa-chevron-right"></i></a>
    
    </span>
  </div>

  <!-- BEGIN comment
  <section class="comment">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'gopherwood';
      var disqus_identifier = 'urn:uuid:4b740694-ab1f-11e3-baaa-040ccecf359c';

      function leave_comment() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          $("#leave_comment_link").css("display", "none");
          $("#collapse_comment_link").css("display", "");
      };
      function collapse_comment() {
          // document.getElementById("disqus_thread").innerHTML = '';
          $("#disqus_thread").slideUp(400, function() {
              $("#disqus_thread").empty();
              $("#leave_comment_link").css("display", "");
              $("#collapse_comment_link").css("display", "none");
              $("#disqus_thread").css("display", "");
          });
      };
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </section>
  END comment -->
  
</article>

        </div>
        <footer>
          <div>
            
            &copy; 2013 ~ 2014 liutaihua | powered by jekyll | thanks <a href="http://lhzhang.com" title="sext vi">sext vi</a> | fork <a href="https://github.com/liutaihua/liutaihua.github.io" title="fork me">me</a>
          </div>
        </footer>
      </div> <!-- main -->
  </body>
</html>
